{{/* Populates layouts/_default/baseof.html */}}

{{ define "main" }}
	{{ if eq "development" hugo.Environment }}
	{{ `<!-- Template: layouts/ncs/ncs.terms.html -->` | safeHTML }}
	{{ end }}

	{{ $thisyear := now.Format "2006" }}

	{{/* Template globals */}}
	{{ $assignments := slice }}
	{{ $annual_roster := "" }}

	{{/* Find the calendar pages with an NCS */}}
	{{ $pages := where .Site.RegularPages "Section" "calendar" }}
 	{{ $pages := $pages | intersect ( where .Site.RegularPages ".Params.ncs" "ne" nil )  }}

	{{/* Collect the NCS call-signs from our list of filtered calendar pages.
	The resulting slice is unordered.
	*/}}
	{{ range ( $pages.GroupByDate "2006" ) }}
		{{ if eq .Key $thisyear }}
			{{ range .Pages }}
				{{ $assignments = $assignments | append .Params.ncs }}
			{{ end }}
		{{ end }}
	{{ end }}

	{{/* Filter the agregated assignments for unique call-signs.
	The resulting slice is unordered.
	*/}}
	{{ $ncs_list :=  $assignments | uniq }}

	{{/* Convert the NCS assignments list from a slice to a string
	     so that we can use it with string.Count
	*/}}
	{{ $assignments := delimit $assignments " " }}

	{{/* Go through the call-sign list, count assignments, and
	     store them in a map.
	*/}}
	{{ range $ncs_list }}
		{{ $call := . }}

 		{{/* Count the assignments for the current $call */}}
		{{ $count := strings.Count $call $assignments }}

		{{ $key := $call }}
		{{ $value := $count }}
		{{ $annual_roster = merge $annual_roster (dict $key $value) }}
	{{ end }}	

	<div class="hentry">
	<header class="entry-header">
		<div class="entry-meta">
			<span class="cat-links">
				<a href="/nets">Nets</a>
			</span>
			{{ $rsspath := "/ncs" }}
			{{ partial "rss" ( dict "rsstitle" "NCS Roster" "rsspath" $rsspath ) }}
		</div>
		<h2 class="entry-title">{{ $thisyear }} NCS Roster</h2>
		<div class="entry-meta">
			<span class="entry-date">
				<a href="{{ .RelPermalink }}" rel="bookmark">
					<time class="entry-date updated" datetime="{{ now.Format "January 2, 2006" }}">
						{{ now.Format "January 2, 2006" }}
					</time>
				</a>
			</span>
		</div><!-- .entry-meta -->
	</header>

	<div class="entry-content" style="padding-bottom:1em;">
		<dl id="list">
		{{/* The roster auto-sorts by key (i.e. call-sign) */}}
		{{ range $key, $value := $annual_roster }}
			<dt class="twocol" style="width:10em;">{{ $key }}</dt>
			<dd class="twocol"><a href="{{ lower $key }}">{{ $value }} net{{ if ne "1" $value }}s{{ end }}</a></dd>
		{{ end }}
		</dl>
		<div class="noprint">
		<h3>Related Links</h3>
		<ul>
			<li><a href="/dates/ncs-schedule">NCS Schedule</a></li>
		 	<li><a href="/ncs/all/">NCS Leaderboard</a></li>
		</ul>
		</div>
		<div class="banner noprint">
			<p>Please contact the <a href="mailto:webmaster@rrra.org">Webmaster Team</a>
			to report erroneous or omitted records.</p>
		</div>
		<p class="clear"></p>
	</div>
	</div>
{{ end }}
